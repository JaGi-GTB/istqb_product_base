\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage
  {markdownthemeistqb_sample-exam_answers}%
  {2024-07-03}%
  {1.0.1}%
  {LaTeX theme for the Markdown Package that typesets ISTQB Sample Exam Answers documents}

% Import common code
\markdownSetup
  {
    import = {
      istqb/sample-exam = metadata,
    },
  }

% Metadata
\keys_define:nn
  { istqb/metadata }
  {
    type .code:n = {
      \tl_gset:Nn
        \g_istqb_type_tl
        { #1~--~Answers }
    },
  }

% Answer key
\RequirePackage
  { multicol }
\RequirePackage
  { supertabular }
\RequirePackage
  { array }
\newcolumntype
  { C }
  [ 1 ]
  { >{ \centering\arraybackslash } p { #1 } }
\tl_new:N
  \l_istqb_answer_key_table_tl
\markdownSetupSnippet
  { answer-key }
  {
    snippet = istqb / sample-exam
      / questions,
    fancyLists = true,
    renderers = {
      jekyllDataEnd = {
        % Start a two-column layout
        \begin { multicols } { 2 }
        \cs_set:Npn
          \newpage
          {
            \if@firstcolumn
              \hrule width
                \linewidth height0pt
              \columnbreak
              % Prevent a page break after the second column.
              \advance \@colroom \@colroom
            \fi
          }
        % Set the dimensions of the table rows.
        \advance
          \@colroom
          1.25cm
        \int_compare:nTF
          { \seq_count:N \g_istqb_questions_seq > 45 }
          {
            \cs_set:Npn
              \arraystretch
              { 0.95 }
          }
          {
            \int_compare:nTF
            { \seq_count:N \g_istqb_questions_seq > 40 }
            {
              \cs_set:Npn
                \arraystretch
                { 1.05 }
            }
            {
              \cs_set:Npn
                \arraystretch
                { 1.20 }
            }
          }
        % Prepare the heading of the table.
        \tablehead
          {
            \hline
            \textbf
              { Question~Number~(\#) } &
            \textbf
              { Correct~Answer } &
            \textbf
              { Learning~Objective~(LO) } &
            \textbf
              { K-Level } &
            \textbf
              { Number~of~Points } \\
          }
        \tabletail { \hline }
        \tablelasttail { \hline }
        \tl_set:Nn
          \l_istqb_answer_key_table_tl
          {
            \begin
              { supertabular }
              { | C { 1.9cm } | C { 1.5cm }
                | C { 2.4cm } | C { 1.4cm }
                | C { 1.9cm } | }
          }
        % Prepare the lines of the table
        \seq_map_inline:Nn
          \g_istqb_questions_seq
          {
            \tl_put_right:Nn
              \l_istqb_answer_key_table_tl
              { \hline }
            % Record the question number.
            \tl_put_right:Nn
              \l_istqb_answer_key_table_tl
              { \textbf { ##1 } & }
            % Record the correct answers.
            \prop_get:cnN
              { g_istqb_answer_correct
                _keys_prop }
              { ##1 }
              \l_tmpa_clist
            \tl_put_right:Ne
              \l_istqb_answer_key_table_tl
              { \clist_use:Nn
                  \l_tmpa_clist
                  { ,~ } &
              }
            % Record the learning objective.
            \tl_put_right:NV
              \l_istqb_answer_key_table_tl
              \g_istqb_prefix_tl
            \tl_put_right:Nn
              \l_istqb_answer_key_table_tl
              { - }
            \prop_get:cnN
              { g_istqb_question_learning
                _objective_prop }
              { ##1 }
              \l_tmpa_tl
            \tl_put_right:NV
              \l_istqb_answer_key_table_tl
              \l_tmpa_tl
            \tl_put_right:Nn
              \l_istqb_answer_key_table_tl
              { & }
            % Record the K-level.
            \prop_get:NnN
              \g_istqb_question_k_level_prop
              { ##1 }
              \l_tmpa_tl
            \tl_put_right:NV
              \l_istqb_answer_key_table_tl
              \l_tmpa_tl
            \tl_put_right:Nn
              \l_istqb_answer_key_table_tl
              { & }
            % Record the number of points.
            \prop_get:cnN
              { g_istqb_question_number
                _of_points_prop }
              { ##1 }
              \l_tmpa_tl
            \tl_put_right:NV
              \l_istqb_answer_key_table_tl
              \l_tmpa_tl
            \tl_put_right:Nn
              \l_istqb_answer_key_table_tl
              { \\ }
          }
        % Typeset the table.
        \tl_put_right:Nn
          \l_istqb_answer_key_table_tl
          { \end { supertabular } }
        \tl_use:N
          \l_istqb_answer_key_table_tl
        % End the two-column layout.
        \end { multicols }
      },
    },
  }

% Answers
\RequirePackage
  { longtable }
\dim_const:Nn
  \c_explanation_width_dim
  { 11.15cm }
\tl_new:N
  \l_istqb_answers_table_tl
\markdownSetupSnippet
  { answers }
  {
    snippet = istqb / sample-exam
      / questions,
    fancyLists = true,
    renderers = {
      interblockSeparator = {
        \par
        \medskip
      },
      jekyllDataEnd = {
        \group_begin:
        % Prepare the heading of the table.
        \cs_set:Npn
          \arraystretch
          { 1.5 }
        \tl_set:Nn
          \l_istqb_answers_table_tl
          {
            \begin
              { longtable }
              { | C { 1.9cm } | C { 1.5cm }
                | p
                { \c_explanation_width_dim }
                | C { 2.4cm } | C { 1.4cm }
                | C { 1.9cm } | }
            \hline
            \textbf
              { Question~Number~(\#) } &
            \textbf { Correct~Answer } &
            \multicolumn
              { 1 }
              { C
                { \c_explanation_width_dim }
                | }
              {
                \textbf
                  { Explanation~/~Rationale }
              } &
            \textbf
              { Learning~Objective~(LO) } &
            \textbf { K-Level } &
            \textbf { Number~of~Points } \\
            \hline
            \endhead
          }
        % Prepare the lines of the table
        \seq_map_inline:Nn
          \g_istqb_questions_seq
          {
            % Record the question number.
            \tl_put_right:Nn
              \l_istqb_answers_table_tl
              {
                \textbf
                  { ##1 }
                \addcontentsline
                  { toc }
                  { subsection }
                  { Question~\# ##1 } &
              }
            % Record the correct answers.
            \prop_get:cnN
              { g_istqb_answer_correct
                _keys_prop }
              { ##1 }
              \l_tmpa_clist
            \tl_put_right:Ne
              \l_istqb_answers_table_tl
              { \clist_use:Nn
                  \l_tmpa_clist
                  { ,~ } &
              }
            % Record the explanation / rationale.
            \tl_put_right:Nn
              \l_istqb_answers_table_tl
              { \begin
                  { minipage }
                  [ t ]
                  {
                    \c_explanation_width_dim
                  }
              }
            \prop_get:cnN
              { g_istqb_question_explanation
                _prop }
              { ##1 }
              \l_tmpa_tl
            \tl_put_right:NV
              \l_istqb_answers_table_tl
              \l_tmpa_tl
            \tl_put_right:Nn
              \l_istqb_answers_table_tl
              { \end { minipage }
                \medskip }
            \tl_put_right:Nn
              \l_istqb_answers_table_tl
              { & }
            % Record the learning objective.
            \tl_put_right:NV
              \l_istqb_answers_table_tl
              \g_istqb_prefix_tl
            \tl_put_right:Nn
              \l_istqb_answers_table_tl
              { - }
            \prop_get:cnN
              { g_istqb_question_learning
                _objective_prop }
              { ##1 }
              \l_tmpa_tl
            \tl_put_right:NV
              \l_istqb_answers_table_tl
              \l_tmpa_tl
            \tl_put_right:Nn
              \l_istqb_answers_table_tl
              { & }
            % Record the K-level.
            \prop_get:NnN
              \g_istqb_question_k_level_prop
              { ##1 }
              \l_tmpa_tl
            \tl_put_right:NV
              \l_istqb_answers_table_tl
              \l_tmpa_tl
            \tl_put_right:Nn
              \l_istqb_answers_table_tl
              { & }
            % Record the number of points.
            \prop_get:cnN
              { g_istqb_question_number_of
                _points_prop }
              { ##1 }
              \l_tmpa_tl
            \tl_put_right:NV
              \l_istqb_answers_table_tl
              \l_tmpa_tl
            \tl_put_right:Nn
              \l_istqb_answers_table_tl
              { \\ \hline }
          }
        % Typeset the table.
        \tl_put_right:Nn
          \l_istqb_answers_table_tl
          { \end { longtable } }
        \tl_use:N
          \l_istqb_answers_table_tl
        \group_end:
      },
    },
  }
\cs_generate_variant:Nn
  \tl_put_right:Nn
  { Ne }
